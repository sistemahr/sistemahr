<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Principal</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="images/icon-152.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="white" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Sistema Visitas">
    <meta name="msapplication-TileImage" content="images/icon-144.png">
    <meta name="msapplication-TileColor" content="#FFFFFF">

    <!-- You MUST include jQuery before Fomantic -->
    <script src="lib/jquery.min.js"></script>
    <script src="lib/semantic.min.js"></script>
    <script src="lib/moment-with-locales.min.js"></script>
    <script src="lib/simpleUpload.min.js"></script>
    <script src="js/globals.js"></script>
    <script src="js/utils.js"></script>

    <link rel="stylesheet" type="text/css" href="lib/semantic.min.css">

    <style type="text/css">
        body {
            background-color: #bbbbbb;
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        .column {
            margin: 10px;
        }

        .col_cal {
            margin-top: 0;
            border-top: 0;
            padding-top: 0;
        }

        div.scrollable {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
            text-align: center;
            padding: 20px;
        }

        #factura_file1 {
            display: inline-block;
            width: 70px;
            height: 70px;
            background-color: white;
            border: 4px dashed #B5B5B5;
            color: #B5B5B5;
            font-size: 50px;
            text-align: center;
            padding: 30px;
        }

        .no_visible {
            display: none;
        }
    </style>
</head>

<body>
    <div class="ui borderless menu">
        <div class="menu">
            <a onclick="window.history.back();" class="item">
                <i class="icon large chevron left"></i>
            </a>
        </div>
        <div class="right menu">
            <a href="bienvenido.html" class="ui item">
                <!-- <i class="icon large question outline"></i> -->

                <i class="large question icon"></i>
            </a>
            <a href="profile.html" class="ui item">
                <i class="icon large cog"></i>
            </a>
            <a id="logoutBtn" href="#" class="ui item">
                <i class="sign out large alternate icon"></i>
            </a>
        </div>
    </div>

    <div class="scrollable">
        <div class="ui middle aligned center aligned grid calendario">
            <div class="column col_cal">
                <h3 id="calendario_titulo">Calendario de visitas</h3>
                <div class="ui calendar" id="inline_calendar"></div>
                <div class="ui secondary menu">
                    <div class="item prevmonth">
                        <i class="left circular inverted chevron icon"></i>
                    </div>
                    <div class="center aligned item">
                        <h3 class="ui center aligned header"></h3>
                    </div>
                    <div class="right aligned item nextmonth">
                        <i class="right circular inverted chevron icon"></i>
                    </div>
                </div>

                <div class="ui segment sumario no_visible">
                    <h4 id="summarioHoras">Total horas: Total: <i class="custom circular info icon"></i>
                    </h4>
                    <div class="ui custom popup top bottom transition hidden">
                        <p id="summarioHorasDetalle">
                            Detalle de horas</b><br>Dias de semana <b>14hs</b> <br> Fin de
                            semana
                            <b>4hs</b><br> Feriados <b>0hs</b></br> <br>
                            <b>Valores</b><br>
                            Dias de semana $350<br>
                            Fines de semana $450<br>
                            Feriados $480<br>
                        </p>
                    </div>
                    <h1 class="ui divider"></h1>
                    <div class="ui compact labeled icon menu">

                        <a id="presentar_horarios" style="display: none;" class="item">
                            <i class="calendar outlook icon"></i>
                            <div class="floating left ui icon blue circular label">
                                1
                            </div>
                            Presentar <br>
                            Horarios
                        </a>
                        <a id="descargar_horarios" style="display: none;" class="item">
                            <i class="download icon"></i>
                            <div class="floating left ui icon green circular label">
                                1
                            </div>
                            Descargar <br>
                            Horarios
                        </a>

                        <a id="presentar_factura" class="disabled item">
                            <i class="receipt icon"></i>
                            <div class="fact_label floating left ui icon grey circular label">2</div>
                            Presentar <br>
                            Factura
                        </a>

                        <a id="descargar_factura" style="display: none;" class="item">
                            <i class="receipt icon"></i>
                            <div class="fact_label floating left ui icon green circular label">2</div>
                            Descargar <br>
                            Factura
                        </a>

                        <a id="presentar_informe" class="disabled item">
                            <div class="informe_label floating left ui icon grey circular label">3</div>
                            <i class="edit outline icon"></i>
                            Presentar <br>
                            Informe
                        </a>

                        <a id="descargar_informe" style="display: none;" class="item">
                            <div class="informe_label floating left ui icon green circular label">3</div>
                            <i class="edit outline icon"></i>
                            Descargar <br>
                            Informe
                        </a>
                    </div>
                </div>
                <!--
                <div class="ui segment sumario" style="display: none;">
                    <h5 id="summarioHoras">Total de horas: 63hs Total: $23.940,00</h5>
                    <p id="summarioHoras1">ds:<b>16.5</b> - fs:<b>12.5</b> - fe:<b>0</b></p>
                    <div class="ui huge buttons">
                        <button id="presentar_horarios" class="ui red button"><i
                                class="calendar outline icon"></i></button>
                        <button id="presentar_factura" class="ui blue button"><i
                                class="file invoice outline icon"></i></button>
                        <button id="presentar_informe" class="ui green button"><i
                                class="edit outline icon"></i></button>
                    </div>
                </div>
            -->
            </div>
        </div>
        <!--

            <div class="ui grid calendario tipotarea" style="display: none;">
                <div class="column">
                    <div class="ui calendar" id="inline_calendar"></div>
                    <div class="ui icon message" style="display: none;">
                        <i class="lock icon"></i>
                        <div class="content">
                            <div class="header">
                                Este mes esta cerrado
                            </div>
                            <p>Esta listo para la liquidacion.</p>
                        </div>
                    </div>
                </div>
            </div>

        -->
    </div>

    <div id="importante_modal_dlg" class="ui tiny modal">
        <div class="header">
            Importante
        </div>
        <div class="content">
            <div class="ui warning message">
                <div class="header">
                    Importante
                </div>
                <div class="content">
                    <p>Debera presentar los horarios correspondientes al mes de Octubre. </p>
                    <p>El plazo es del 1 al 5 de este mes para presentar las visitas correspondientes al mes de Octubre.
                    </p>
                    <p>En caso de pasada esa fecha, los honorarios seran procesados a partir del 10 del mes siguiente.
                    </p>
                </div>
            </div>
        </div>
        <div class="actions">
            <div class="ui negative button">
                Entendido
            </div>
        </div>
    </div>

    <div id="presentacion_modal_dlg" class="ui tiny modal">
        <div class="header">
            Presentar horarios
        </div>
        <div id="sendingPrDimmer" class="ui inverted dimmer">
            <div class="ui text loader">Enviando Presentacion</div>
        </div>
        <div id="presentacion_horaria_content" class="content">
            <h4>Se realizara la presentacion horaria correspondiente al mes de Octubre 2020.</h4>
            <p>Se cuenta con un total de 63hs. repartidas entre: </p>
            <ul>
                <li>40hs. DS x 380 = <strong>$1560</strong></li>
                <li>23hs. FS x 400 = <strong>$1560</strong></li>
            </ul>
            <div class="ui divider"></div>
            <h3>Total: $23.940,00</h3>
            <h4>Debera realizar la factura con este importe.</h4>
            <div class="ui error message">
                <div class="header">
                    Aviso
                </div>
                <div class="content">
                    <p>Se realizara la presentacion horaria, una vez confirmada no se podran actualizar ni editar
                        las
                        visitas del mes.<br>
                        Para pedir una rectificacion debera comunicarse con el administrador.</p>
                </div>
            </div>
        </div>
        <div class="actions">
            <div class="ui negative button">
                Cancelar
            </div>
            <div class="ui positive button">
                Confirmar
            </div>
        </div>
    </div>

    <div id="factura_modal_dlg" class="ui tiny modal">
        <div class="header">
            Carga de factura
        </div>
        <div class="content">
            <div id="sendingFactDimmer" class="ui inverted dimmer">
                <div class="ui text loader">Enviando Factura</div>
            </div>
            <h3 id="totalFacturaDescr">La factura correspondiente a Octubre 2020 debera tener un importe de:</h3>
            <h2 id="totalFactura">$23.940,00</h2>

            <input class="ui input" id="factura_file" type="file" accept="image/*,application/pdf" name="facfile" />

            <div class="ui warning message">
                <div class="header">
                    Nota
                </div>
                <div class="content">
                    <p>La carga de la factura se puede realizar varias veces pero se podra confirmar una sola vez.</p>
                    <p>En caso que se necesite volver a cargar la factura despues de confirmar debera comunicarse cone
                        el administrador para habilitar la recarga.</p>
                </div>
            </div>
        </div>
        <div class="actions">
            <div class="ui negative button">
                Cerrar
            </div>
        </div>
    </div>

    <div id="informe_modal_dlg" class="ui tiny modal">
        <div class="header">
            Carga de informe
        </div>
        <div class="content">
            <div id="sendingInfDimmer" class="ui inverted dimmer">
                <div class="ui text loader">Guardando</div>
            </div>

            <form id="informe_form" class="ui form">
                <div class="field">
                    <label>Ingresar informe evolutivo del mes del paciente.</label>
                    <textarea id="informe" name="informe"></textarea>
                </div>
                <p id="charnum"></p>
                <div class="ui error message">
                </div>
            </form>
            <div class="ui warning message">
                <div class="header">
                    Nota
                </div>
                <div class="content">
                    <p>En caso que se necesite volver a cargar el informe debera comunicarse con el administrador para
                        habilitar la carga.</p>
                </div>
            </div>
        </div>
        <div class="actions">
            <div class="ui negative button">
                Cancelar
            </div>
            <div class="ui positive button">
                Confirmar
            </div>
        </div>
    </div>

    <div id="confirma_salir_dlg" class="ui modal">
        <div class="header">
            Advertencia
        </div>
        <div class="content">
            <div class="description">
                <h2>&iquest;Desea cerrar sesion&#63;</h2>
            </div>
        </div>
        <div class="actions">
            <div class="ui negative button">
                Cancelar
            </div>
            <div class="ui positive button">
                Confirmar
            </div>
        </div>
    </div>

    <script>
        const apiUrl = "https://www.conectat.com.ar/api";
        let pac = null;
        let focusDate = null;
        let presentationData = null;

        $(document).ready(function () {
            if (localStorage.getItem("user") === null) {
                window.location.href = "login.html";
            }

            //Inicializamos los controles
            $("#summarioHoras1").hide();

            //Si selecciono fecha, la guardamos
            if (localStorage.getItem("pac") !== null) {
                pac = localStorage.getItem("pac");
            } else {
                pac = findGetParameter("pac");
            }
            if (pac === null) {
                //Si es llamado sin parametro o no esta en localStorage, deslogueamos
                localStorage.removeItem("user");
                localStorage.removeItem("focusDate");
                localStorage.removeItem("pac");
                window.location.href = "login.html";
                return true;
            }

            cargarVisitasCalendario(pac);

            //Si selecciono fecha, la guardamos
            if (localStorage.getItem("focusDate") === null) {
                focusDate = moment();
                localStorage.setItem("focusDate", focusDate.format("YYYY-MM-DDTHH:mm:ss"));
            } else {
                focusDate = moment(localStorage.getItem("focusDate"));
            }

            //mostrarSumario();

            $('#inline_calendar').calendar('set date', focusDate._d);

            // Traemos el estado del mes, si no presento los valores, traemos el estado de la presentacion
            getTotalMonth(focusDate._d);

            //Dialogos
            $("#confirma_salir_dlg").modal({
                onShow: function () {
                },
                onDeny: function () {
                    return true;
                },
                onApprove: function () {
                    localStorage.removeItem("user");
                    localStorage.removeItem("focusDate");
                    localStorage.removeItem("pac");
                    window.location.href = "login.html";
                    return true;
                }
            });

            $("#factura_modal_dlg").modal({
                onShow: function () {
                    let totalFactContent = `$${presentationData["total_pagar"]}`;
                    totalFactContent = totalFactContent.replace(/\./g, ',');

                    let periodo = focusDate.locale("es").format("MMMM YYYY");
                    let facturaDescr = `La factura correspondiente a ${periodo} debera tener un importe de:`;
                    $("#totalFacturaDescr").html(facturaDescr);

                    $("#totalFactura").html(totalFactContent);
                },
                onDeny: function () {
                    return true;
                },
                onApprove: function () {
                    //enviarPresentacion();
                    return true;
                }
            });

            $("#informe_modal_dlg").modal({
                onShow: function () {
                    $('#informe_form').form({
                        on: 'change',
                        fields: {
                            informe: {
                                identifier: 'informe',
                                rules: [{
                                    type: 'empty',
                                    prompt: 'Por favor ingrese algun contenido al informe'
                                },
                                {
                                    type: 'minLength[1500]',
                                    prompt: 'Su informe debe contener al menos {ruleValue} caracteres'
                                },
                                {
                                    type: 'maxLength[5000]',
                                    prompt: 'Su informe supera el maximo de {ruleValue} caracteres'
                                }]
                            }
                        }
                    });
                },
                onApprove: function () {
                    //Chequeamos que se haya ingresado el informe
                    let formInforme = $('#informe_form');

                    if (!formInforme.form("validate form")) {
                        return false;
                    }

                    // get all values
                    let allFields = formInforme.form('get values');
                    console.log(allFields);

                    enviarInforme(allFields);
                    return true;
                }
            });

            $("#presentacion_modal_dlg").modal({
                onShow: function () {
                    let periodo = focusDate.locale("es").format("MMMM YYYY");

                    let presentacionHorariaContent = `<h4>Se realizara la presentacion horaria correspondiente al mes de ${periodo}</h4>
                                                      <p>Se cuenta con un total de ${presentationData["total_hs"]}hs. repartidas entre: </p>
                                                      <ul>
                                                          <li>${presentationData["total_hs_ds"]}hs. DS x ${presentationData["valor_hora_ds"]} = <strong>$${presentationData["total_pagar_ds"]}</strong></li>
                                                          <li>${presentationData["total_hs_fs"]}hs. FS x ${presentationData["valor_hora_fs"]} = <strong>$${presentationData["total_pagar_fs"]}</strong></li>
                                                          <li>${presentationData["total_hs_fe"]}hs. FE x ${presentationData["valor_hora_fe"]} = <strong>$${presentationData["total_pagar_fe"]}</strong></li>
                                                      </ul>
                                                      <div class="ui divider"></div>
                                                      <h3>Total: $${presentationData["total_pagar"]}</h3>
                                                      <h4>Debera realizar la factura con este importe.</h4>
                                                      <div class="ui error message">
                                                          <div class="header">
                                                              Aviso
                                                          </div>
                                                          <div class="content">
                                                              <p>Se realizara la presentacion horaria, una vez confirmada no se podr&aacute;ran actualizar ni editar
                                                                  las visitas del mes<br>
                                                                  Para pedir una rectificaci&oacute;n debera comunicarse con el administrador</p>
                                                          </div>
                                                      </div>`;
                    presentacionHorariaContent = presentacionHorariaContent.replace(/\./g, ',');


                    $("#presentacion_horaria_content").html(presentacionHorariaContent);
                },
                onApprove: function () {
                    enviarPresentacion();
                    return true;
                }
            });

            //Eventos
            $("#presentar_horarios").click(function () {
                $('#presentacion_modal_dlg').modal('show');
            });

            $("#presentar_factura").click(function () {
                $('#factura_modal_dlg').modal('show');
            });

            $("#presentar_informe").click(function () {
                $('#informe_modal_dlg').modal('show');
            });

            $("#presentar_informe").click(function () {
                $('#informe_modal_dlg').modal('show');
            });

            $("#logoutBtn").click(function () {
                $("#confirma_salir_dlg").modal("show");
            });

            $('#factura_file').change(function () {
                let url = `${apiUrl}/fact_upload.php`;
                let user = JSON.parse(localStorage.getItem('user'));

                let jwtString = `Bearer ${user.jwt}`;

                $(this).simpleUpload(url, {
                    data: {
                        "id": presentationData.id
                    },
                    beforeSend: function (jqXHR, settings) {
                        jqXHR.setRequestHeader('MyAuthorization', jwtString);
                        $("#sendingFactDimmer").addClass("active");
                    },
                    start: function (file) {
                        //upload started
                        console.log("upload started");
                    },

                    progress: function (progress) {
                        //received progress
                        console.log("upload progress: " + Math.round(progress) + "%");
                    },

                    success: function (data) {
                        //upload successful
                        $("#sendingFactDimmer").removeClass("active");
                        $("#factura_modal_dlg").modal('hide');
                        getTotalMonth(focusDate._d);
                        console.log("upload successful!");
                        console.log(data);
                    },

                    error: function (error) {
                        //upload failed
                        $("#sendingFactDimmer").removeClass("active");
                        $("#factura_modal_dlg").modal('hide');
                        getTotalMonth(focusDate._d);
                        console.log("upload error: " + error.name + ": " + error.message);
                    }

                });

            });

            $(".nextmonth").click(function (e) {
                e.preventDefault();

                //Si es de un mes anterior, aumentamos un mes
                if (focusDate.isSameOrBefore(moment(), 'month')) {
                    focusDate = moment(focusDate).add(1, 'M');
                    // Si la fecha aumentada es mayor al dia de hoy, ponemos la fecha de hoy
                    if (focusDate.isAfter(moment(), 'day')) {
                        focusDate = moment();
                    }

                    saveFocusDate();
                    setCalFocusDate();
                }

                getTotalMonth(focusDate._d);
            });

            $(".prevmonth").click(function (e) {
                e.preventDefault();

                //Si es de un mes anterior, aumentamos un mes
                if (focusDate.isSameOrBefore(moment(), 'month')) {
                    focusDate = moment(focusDate).subtract(1, 'M');

                    saveFocusDate();
                    setCalFocusDate();
                }

                getTotalMonth(focusDate._d);
            });

            $('#informe').keyup(function () {
                var max = 5000;
                var len = $(this).val().length;
                if (len >= max) {
                    $('#charnum').text(' Superaste el limite');
                } else {
                    var char = max - len;
                    $('#charnum').text('te quedan ' + char + ' caracteres.');
                }
            });

            $("#descargar_horarios").click(function (e) {
                let month = focusDate._d.getMonth() + 1;
                let year = focusDate._d.getFullYear();

                let requestOptions = {
                    method: 'GET',
                    headers: getMyHeader(),
                    redirect: 'follow'
                };

                let url = `${apiUrl}/presentaciones.php?year=${year}&month=${month}&pac=${pac}&pdf`;

                fetch(url, requestOptions)
                    .then(response => response.blob())
                    .then(blob => {
                        var url = window.URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = `presentacion-${month}-${year}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    });

            });

            $("#descargar_factura").click(function (e) {
                let month = focusDate._d.getMonth() + 1;
                let year = focusDate._d.getFullYear();

                let requestOptions = {
                    method: 'GET',
                    headers: getMyHeader(),
                    redirect: 'follow'
                };

                let url = `${apiUrl}/presentaciones.php?year=${year}&month=${month}&pac=${pac}&factura`;

                fetch(url, requestOptions)
                    .then(response => response.blob())
                    .then(blob => {
                        var url = window.URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = `factura-${month}-${year}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    });

            });

            $("#descargar_informe").click(function (e) {
                let month = focusDate._d.getMonth() + 1;
                let year = focusDate._d.getFullYear();

                let requestOptions = {
                    method: 'GET',
                    headers: getMyHeader(),
                    redirect: 'follow'
                };

                let url = `${apiUrl}/presentaciones.php?year=${year}&month=${month}&pac=${pac}&informe`;

                fetch(url, requestOptions)
                    .then(response => response.blob())
                    .then(blob => {
                        var url = window.URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = `informe-${month}-${year}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    });

            });

        });

        // Get a value from the querystring
        function findGetParameter(parameterName) {
            var result = null,
                tmp = [];
            var items = location.search.substr(1).split("&");
            for (var index = 0; index < items.length; index++) {
                tmp = items[index].split("=");
                if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
            }
            return result;
        }

        function cargarVisitasCalendario(pac) {
            let requestOptions = {
                method: 'GET',
                headers: getMyHeader(),
                redirect: 'follow'
            };

            let url = `${apiUrl}/visitas.php`;

            if (pac != undefined) {
                url = `${apiUrl}/visitas.php?pac=${pac}&calendarview=1`
            }

            //*****************************************
            fetch(url, requestOptions)
                .then(function (res) {
                    return res.json(); //error here
                }).then(function (data) {
                    $('.calendario').show();

                    let events = [];

                    for (const key in data) {
                        if (data.hasOwnProperty(key)) {
                            const element = data[key];
                            let parts = element.dt.split('-');

                            var mydate = new Date(parts[0], parts[1] - 1, parts[2]);

                            let typeClass = element.cantidad_solapados == '0' ? 'green' : 'inverted orange';
                            let indicador = element.cantidad_solapados == '0' ? 'Visitas' : 'Visitas solapadas';
                            //class: 'inverted orange'
                            let event = {
                                date: mydate,
                                message: indicador,
                                class: typeClass
                            }
                            events.push(event);
                        }
                    }

                    initializeCalendar(events);
                    return;
                }).catch((error) => {
                    console.log(error);
                });

        }

        Date.isLeapYear = function (year) {
            return (((year % 4 === 0) && (year % 100 !== 0)) || (year % 400 === 0));
        };

        Date.getDaysInMonth = function (year, month) {
            return [31, (Date.isLeapYear(year) ? 29 : 28), 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][month];
        };

        Date.prototype.isLeapYear = function () {
            return Date.isLeapYear(this.getFullYear());
        };

        Date.prototype.getDaysInMonth = function () {
            return Date.getDaysInMonth(this.getFullYear(), this.getMonth());
        };

        Date.prototype.addMonths = function (value) {
            var n = this.getDate();
            this.setDate(1);
            this.setMonth(this.getMonth() + value);
            this.setDate(Math.min(n, this.getDaysInMonth()));
            return this;
        };

        function formatDate(date) {
            var d = new Date(date),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate(),
                year = d.getFullYear();

            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;

            return [year, month, day].join('');
        }

        function initializeCalendar(events) {
            let today = new Date();
            $('#inline_calendar').html('');
            $('#inline_calendar')
                .calendar({
                    type: "day",
                    inline: true,
                    disableYear: true,
                    disableMonth: true,
                    text: {
                        days: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa'],
                        months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                        monthsShort: ['En', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                        today: 'Hoy',
                        now: 'Ahora',
                        am: 'AM',
                        pm: 'PM'
                    },
                    eventDates: events,
                    maxDate: new Date(today.getFullYear(), today.getMonth(), today.getDate()),
                    onSelect(date, mode) {
                        focusDate = moment(date);
                        localStorage.setItem("focusDate", focusDate.format("YYYY-MM-DDTHH:mm:ss"));
                        let formatted_date = formatDate(date);
                        let url = `/visitas.html?date=${formatted_date}&pac=${pac}`;
                        window.location = url;
                    },
                    className: {
                        prevIcon: '',
                        nextIcon: ''
                    }
                });

            if (focusDate !== null) {
                $('#inline_calendar').calendar('set date', focusDate._d);
                getTotalMonth(focusDate._d);
            }

        }

        function getTotalMonth(date) {
            let month = date.getMonth() + 1;
            let year = date.getFullYear();

            let requestOptions = {
                method: 'GET',
                headers: getMyHeader(),
                redirect: 'follow'
            };

            let url = `${apiUrl}/presentaciones.php?year=${year}&month=${month}&pac=${pac}&presentacion`;

            $(".sumario").hide();
            fetch(url, requestOptions)
                .then(function (res) {
                    return res.json(); //error here
                }).then(function (data) {
                    presentationData = data;
                    if (data.total_hs > 0) {
                        $(".sumario").show();
                        $(".sumario").removeClass("no_visible");
                    } else {
                        $(".sumario").hide();
                        $(".sumario").addClass("no_visible");
                        return;
                    }

                    let sumarioHoras = `Total de horas: ${data["total_hs"]}hs Total: $${data["total_pagar"]} <i class="custom circular info icon"></i>`;

                    sumarioHoras = sumarioHoras.replace(/\./g, ',');
                    $("#summarioHoras").html(sumarioHoras);

                    sumarioHoras = `<b>Detalle de horas</b><br>
                                    Dias de semana <b>${data["total_hs_ds"]}hs</b><br> 
                                    Fin de semana <b>${data["total_hs_fs"]}hs</b><br> 
                                    Feriados <b>${data["total_hs_fe"]}hs</b><br>
                                    <b>Valores</b><br>
                                    Dias de semana $${data["valor_hora_ds"]}<br>
                                    Fines de semana $${data["valor_hora_fs"]}<br>
                                    Feriados $${data["valor_hora_fe"]}<br>`;

                    sumarioHoras = sumarioHoras.replace(/\./g, ',');
                    $("#summarioHorasDetalle").html(sumarioHoras);

                    $('.custom')
                        .popup({
                            popup: $('.custom.popup'),
                            on: 'click'
                        });

                    $(".fact_label").removeClass("grey");
                    $(".fact_label").removeClass("green");
                    $(".fact_label").removeClass("blue");
                    $(".informe_label").removeClass("grey");
                    $(".informe_label").removeClass("green");
                    $(".informe_label").removeClass("blue");

                    $("#presentar_factura").addClass("disabled");
                    $("#presentar_informe").addClass("disabled");

                    if ("id" in data) {
                        $("#presentar_horarios").hide();
                        $("#descargar_horarios").show();

                        //Si ya se presento el horario, habilitar la carga de factura
                        if (data.factura == "S") {
                            $("#descargar_factura").hide();
                            $("#presentar_factura").show();
                            $("#presentar_factura").removeClass("disabled");
                            $(".fact_label").addClass("green");

                            if (data.informe == "S") {
                                $("#descargar_factura").show();
                                $("#presentar_factura").hide();
                                $(".fact_label").addClass("green");

                                $("#descargar_informe").show();
                                $("#presentar_informe").hide();
                                $("#presentar_informe").addClass("disabled");
                                $(".informe_label").addClass("green");
                            } else {
                                $("#descargar_informe").hide();
                                $("#presentar_informe").show();
                                $("#presentar_informe").removeClass("disabled");
                                $(".informe_label").addClass("blue");
                            }

                        } else {
                            $("#descargar_factura").hide();
                            $("#presentar_factura").show();
                            $("#presentar_factura").removeClass("disabled");
                            $(".fact_label").addClass("blue");
                        }

                    } else {
                        $("#presentar_horarios").show();
                        $("#descargar_horarios").hide();

                        $(".fact_label").addClass("grey");
                        $(".informe_label").addClass("grey");
                    }

                });

            /*
            $("#summarioHoras1").hide();

            //Al mandar, deshabilitamos todo
            

            $("#presentar_horarios").addClass("disabled");
            $("#presentar_factura").addClass("disabled");
            $("#presentar_informe").addClass("disabled");

            fetch(url, requestOptions)
                .then(function (res) {
                    return res.json(); //error here
                }).then(function (data) {
                    $("#summarioHoras1").show();
                    presentationData = data;

                    let sumarioHoras = `Total de horas: ${data["total_hs"]}hs Total: $${data["total_pagar"]}`;

                    sumarioHoras = sumarioHoras.replace(/\./g, ',');
                    $("#summarioHoras").html(sumarioHoras);

                    sumarioHoras = `DS:<b>${data["total_hs_ds"]}hs</b>, FS:<b>${data["total_hs_fs"]}hs</b>, FE:<b>${data["total_hs_fe"]}hs</b> <br>Valor hora: DS:$${data["valor_hora_ds"]}, FS:$${data["valor_hora_fs"]}, FE:$${data["valor_hora_fe"]} `;
                    sumarioHoras = sumarioHoras.replace(/\./g, ',');
                    $("#summarioHoras1").html(sumarioHoras);

                    //Si vino el id, deshabilitamos el boton de presentacion
                    let presento = false;
                    let facturo = false;
                    let informo = false;
                    let tienehoras = false;

                    if ("id" in data) {
                        presento = true;
                        tienehoras = true;
                        //mostrarSumario(tienehoras);
                        $(".sumario").show();

                        //Si ya presento, deshabilitamos la presetnacion y revisamos si ingreso factura
                        $("#presentar_horarios").addClass("disabled");

                        //Si presento factura deshabilitamos el boton
                        if (data["factura"] == "S") {
                            facturo = true;
                            $("#presentar_factura").addClass("disabled");
                        } else {
                            $("#presentar_factura").removeClass("disabled");
                        }
                        //Si presento informe deshabilitamos
                        if (data["informe"] == "S") {
                            informo = true;
                            $("#presentar_informe").addClass("disabled");
                        } else if (facturo) {
                            //Mostrar solo si facturo
                            $("#presentar_informe").removeClass("disabled");
                        }
                    } else {
                        if (data["total_hs"] == 0) {
                            $(".sumario").hide();
                            $("#presentar_horarios").addClass("disabled");
                            $("#presentar_factura").addClass("disabled");
                            $("#presentar_informe").addClass("disabled");
                            tienehoras = false;
                        } else {
                            tienehoras = true;
                            $("#presentar_horarios").removeClass("disabled");
                            $(".sumario").show();
                        }
                        //mostrarSumario(tienehoras);
                    }

                    //mostrarSumario(tienehoras);

                    //Ponemos en el titulo de la vista el nombre del paciente.
                    let titulo = `Calendario de visitas - Paciente ${data["iniciales"]}`;
                    $("#calendario_titulo").html(titulo);
                    return;
                }).catch((error) => {
                    console.log(error);
                });
            */
        }

        function enviarPresentacion() {
            let month = focusDate._d.getMonth() + 1;
            let year = focusDate._d.getFullYear();

            let requestOptions = {
                method: 'POST',
                headers: getMyHeader(),
                redirect: 'follow'
            };

            let url = `${apiUrl}/presentaciones.php?year=${year}&month=${month}&pac=${pac}&presentacion`;

            $("#sendingPrDimmer").addClass("active");
            fetch(url, requestOptions)
                .then(function (res) {
                    return res.json(); //error here
                }).then(function (data) {
                    $("#sendingPrDimmer").removeClass("active");
                    $("#presentacion_modal_dlg").modal('hide');
                    $('#importante_modal_dlg').modal('show');
                    getTotalMonth(focusDate._d);
                    return;
                }).catch((error) => {
                    console.log(error);
                });
        }

        function enviarInforme(informeData) {
            let idPresentacion = presentationData["id"];
            let raw = JSON.stringify(informeData);

            let requestOptions = {
                method: 'POST',
                headers: getMyHeader(),
                body: raw,
                redirect: 'follow'
            };

            let url = `${apiUrl}/presentaciones.php?id=${idPresentacion}?presentacion&informe`;

            $("#sendingInfDimmer").addClass("active");
            fetch(url, requestOptions)
                .then(function (res) {
                    return res.json(); //error here
                }).then(function (data) {
                    $("#sendingInfDimmer").removeClass("active");
                    $("#informe_modal_dlg").modal('hide');
                    getTotalMonth(focusDate._d);
                    return;
                }).catch((error) => {
                    console.log(error);
                });
        }

        /*
        function mostrarSumario(thoras = true) {
            //Un Dia antes de fin de mes
            let finMes = moment().endOf('month').subtract(1, 'day');

            if (thoras && (!focusDate.isSame(moment(), 'month') ||
                focusDate.isSame(finMes, 'day'))) {
                $('.sumario').show();
            } else {
                $('.sumario').hide();
            }
        }*/

        function saveFocusDate() {
            localStorage.setItem("focusDate", focusDate.format("YYYY-MM-DDTHH:mm:ss"));
        };

        function setCalFocusDate() {
            $('#inline_calendar').calendar('set focusDate', focusDate._d);
            $('#inline_calendar').calendar('set date', focusDate._d);
        }
    </script>

</body>

</html>